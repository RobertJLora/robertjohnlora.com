---
import Layout from '../layouts/Layout.astro';
---

<Layout
  title="Halftone Generator"
  description="Convert any image to a halftone dot pattern with amber/gold tones. Free, runs in your browser."
  currentSlug="halftone"
  noindex={true}
>
  <div class="note-content">
    <h1>ðŸŽ¨ halftone generator</h1>

    <p>upload an image to convert it to halftone dots. works entirely in your browser.</p>

    <!-- Upload area -->
    <div id="upload-area" class="upload-area">
      <input type="file" id="file-input" accept="image/*" class="hidden" />
      <div class="upload-content">
        <span class="upload-icon">ðŸ“·</span>
        <p>drag & drop or click to upload</p>
        <p class="upload-hint">supports jpg, png, webp</p>
      </div>
    </div>

    <!-- Preview area -->
    <div id="preview-area" class="preview-area hidden">
      <div class="canvases">
        <div class="canvas-container">
          <span class="canvas-label">original</span>
          <canvas id="original-canvas"></canvas>
        </div>
        <div class="canvas-container">
          <span class="canvas-label">halftone</span>
          <canvas id="halftone-canvas"></canvas>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div class="control-group">
          <label for="dot-size">dot size</label>
          <input type="range" id="dot-size" min="2" max="12" value="6" />
          <span id="dot-size-value">6</span>
        </div>
        <div class="control-group">
          <label for="spacing">spacing</label>
          <input type="range" id="spacing" min="4" max="20" value="8" />
          <span id="spacing-value">8</span>
        </div>
        <div class="control-group">
          <label for="contrast">contrast</label>
          <input type="range" id="contrast" min="0.5" max="2" step="0.1" value="1.2" />
          <span id="contrast-value">1.2</span>
        </div>
      </div>

      <div class="action-buttons">
        <button id="download-btn" class="action-btn primary">download</button>
        <button id="reset-btn" class="action-btn">upload new</button>
      </div>
    </div>
  </div>

  <script>
    const uploadArea = document.getElementById('upload-area');
    const previewArea = document.getElementById('preview-area');
    const fileInput = document.getElementById('file-input') as HTMLInputElement;
    const originalCanvas = document.getElementById('original-canvas') as HTMLCanvasElement;
    const halftoneCanvas = document.getElementById('halftone-canvas') as HTMLCanvasElement;
    const dotSizeSlider = document.getElementById('dot-size') as HTMLInputElement;
    const spacingSlider = document.getElementById('spacing') as HTMLInputElement;
    const contrastSlider = document.getElementById('contrast') as HTMLInputElement;
    const downloadBtn = document.getElementById('download-btn');
    const resetBtn = document.getElementById('reset-btn');

    let originalImage: HTMLImageElement | null = null;

    // Upload handling
    uploadArea?.addEventListener('click', () => fileInput?.click());

    uploadArea?.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea?.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea?.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer?.files[0];
      if (file && file.type.startsWith('image/')) {
        loadImage(file);
      }
    });

    fileInput?.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (file) {
        loadImage(file);
      }
    });

    function loadImage(file: File) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          originalImage = img;
          showPreview();
          renderHalftone();
        };
        img.src = e.target?.result as string;
      };
      reader.readAsDataURL(file);
    }

    function showPreview() {
      uploadArea?.classList.add('hidden');
      previewArea?.classList.remove('hidden');
    }

    function renderHalftone() {
      if (!originalImage) return;

      const maxSize = 400;
      let width = originalImage.width;
      let height = originalImage.height;

      // Scale down if too large
      if (width > maxSize || height > maxSize) {
        const ratio = Math.min(maxSize / width, maxSize / height);
        width = Math.floor(width * ratio);
        height = Math.floor(height * ratio);
      }

      // Set canvas sizes
      originalCanvas.width = width;
      originalCanvas.height = height;
      halftoneCanvas.width = width;
      halftoneCanvas.height = height;

      // Draw original
      const origCtx = originalCanvas.getContext('2d')!;
      origCtx.drawImage(originalImage, 0, 0, width, height);

      // Get parameters
      const dotSize = parseFloat(dotSizeSlider.value);
      const spacing = parseFloat(spacingSlider.value);
      const contrast = parseFloat(contrastSlider.value);

      // Get image data
      const imageData = origCtx.getImageData(0, 0, width, height);
      const pixels = imageData.data;

      // Prepare halftone canvas
      const hCtx = halftoneCanvas.getContext('2d')!;

      // Check if dark mode
      const isDark = document.documentElement.classList.contains('dark');
      hCtx.fillStyle = isDark ? '#000000' : '#ffffff';
      hCtx.fillRect(0, 0, width, height);

      // Amber color for dots
      const dotColor = '#E8A836';

      // Generate halftone pattern
      for (let y = spacing / 2; y < height; y += spacing) {
        for (let x = spacing / 2; x < width; x += spacing) {
          // Sample brightness at this point
          const px = Math.floor(x);
          const py = Math.floor(y);
          const i = (py * width + px) * 4;

          const r = pixels[i];
          const g = pixels[i + 1];
          const b = pixels[i + 2];

          // Convert to grayscale
          let brightness = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

          // Apply contrast
          brightness = Math.pow(brightness, 1 / contrast);

          // Invert for dark mode (dark areas = big dots)
          if (isDark) {
            brightness = 1 - brightness;
          }

          // Calculate dot radius based on brightness
          const radius = brightness * dotSize;

          if (radius > 0.5) {
            hCtx.beginPath();
            hCtx.arc(x, y, radius, 0, Math.PI * 2);
            hCtx.fillStyle = dotColor;
            hCtx.fill();
          }
        }
      }
    }

    // Slider event listeners
    dotSizeSlider?.addEventListener('input', () => {
      document.getElementById('dot-size-value')!.textContent = dotSizeSlider.value;
      renderHalftone();
    });

    spacingSlider?.addEventListener('input', () => {
      document.getElementById('spacing-value')!.textContent = spacingSlider.value;
      renderHalftone();
    });

    contrastSlider?.addEventListener('input', () => {
      document.getElementById('contrast-value')!.textContent = contrastSlider.value;
      renderHalftone();
    });

    // Download
    downloadBtn?.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'halftone-avatar.png';
      link.href = halftoneCanvas.toDataURL('image/png');
      link.click();
    });

    // Reset
    resetBtn?.addEventListener('click', () => {
      originalImage = null;
      previewArea?.classList.add('hidden');
      uploadArea?.classList.remove('hidden');
      if (fileInput) fileInput.value = '';
    });
  </script>

  <style>
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 1.5rem 0;
    }

    .upload-area:hover,
    .upload-area.dragover {
      border-color: var(--amber-accent);
      background: var(--amber-bg-subtle);
    }

    .upload-content {
      pointer-events: none;
    }

    .upload-icon {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.5rem;
    }

    .upload-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    .hidden {
      display: none !important;
    }

    .preview-area {
      margin-top: 1.5rem;
    }

    .canvases {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .canvas-container {
      text-align: center;
    }

    .canvas-label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    canvas {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .control-group label {
      width: 70px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .control-group input[type="range"] {
      flex: 1;
      accent-color: var(--amber-accent);
    }

    .control-group span {
      width: 30px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
    }

    .action-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .action-btn:hover {
      border-color: var(--amber-accent);
      background: var(--amber-bg-subtle);
    }

    .action-btn.primary {
      background: var(--amber-accent);
      border-color: var(--amber-accent);
      color: #000;
    }

    .action-btn.primary:hover {
      opacity: 0.9;
    }

    @media (max-width: 480px) {
      .canvases {
        flex-direction: column;
        align-items: center;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</Layout>
